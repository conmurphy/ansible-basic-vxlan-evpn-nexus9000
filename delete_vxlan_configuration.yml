- hosts: all
  gather_facts: False
  strategy: free

  tasks: 
      # Needed to add this before disabling the feature
      # otherwise it's not cleaned up correctly
    - name: Remove Distributed Anycast Gateway MAC Address on Leaves
      nxos_config:
        lines:
          - no fabric forwarding anycast-gateway-mac 

    - name: Disable features which removes config
      cisco.nxos.nxos_feature:
        feature: '{{ item.feature }}'
        state: disabled
      with_items: '{{ vxlan_features }}'
    
    - name: Disable EVPN overlay
      nxos_evpn_global:
        nv_overlay_evpn: false
    
    - name: Delete Tenant VRF
      nxos_vrf:
        name: '{{ item.name }}'
        state: absent
      with_items: '{{ tenant_a_vrf_config }}'

    - name: Remove Host Facing L2 Interfaces
      nxos_l2_interfaces:
        config: 
          - name: '{{item.name}}'
        state: deleted
      with_items: '{{ host_facing_ifaces }}'

    - name: Delete loopbacks
      cisco.nxos.nxos_interfaces:
        config:
          - name: lo0
            enabled: no
          - name: lo1
            enabled: no
        state: deleted
      ignore_errors: yes

    - name: Delete interface config
      cisco.nxos.nxos_interfaces:
        config:
          - name: '{{item.name}}'
        state: deleted 
      with_items: 
        - '{{ fabric_ifaces }}'
        - '{{ host_facing_ifaces }}'

    - name: Delete VLANs
      cisco.nxos.nxos_vlans:
        config:
          - vlan_id: '{{ item.vlan_id }}'
            name: '{{ item.name }}'
        state: deleted
      with_items: '{{ tenant_a_vlan_to_vni }}'

    # - name: Saving Configuration
    #   nxos_config:
    #     save_when: changed
