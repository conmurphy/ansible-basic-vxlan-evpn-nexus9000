- hosts: all
  gather_facts: False
  strategy: free
  vars:
    tag: ""
    commands:
      - command: show version
        tags: 
        - mgmt
      - command: show module
        tags: 
        - mgmt
      - command: show ip route
        tags: 
        - l3
        - routing
      - command: show ip route bgp vrf tenant_a
        tags: 
        - l3
        - routing
        - bgp
      - command: show vxlan
        tags: 
        - vxlan
      - command: show l2route evpn mac evi 10
        tags: 
        - vxlan
      - command: show l2route evpn mac-ip evi 10
        tags: 
        - vxlan
      - command: show bgp l2vpn evpn
        tags: 
        - vxlan
      - command: show bgp l2vpn evpn vni-id 100010
        tags: 
        - vxlan
      - command: show bgp l2vpn evpn neighbor
        tags: 
        - vxlan
      - command: show bgp l2vpn evpn neighbor 10.201.1.1 routes
        tags: 
        - vxlan

      # - "show ip route bgp"
      # - "show ip bgp"
      # - "show nve peers"
      # - "show bgp internal nve-peer-vni"
      # - "show interface nve 1"
      # - "show nve vxlan-params"
      # - "show nve internal platform interface nve1 detail"
      # - "show nve peer detail"
      # - "show bgp internal evi 100010"

  tasks:
  - name: IF TAG PROVIDED - Run show commands based on tag
    set_fact:
      commands: "{{ commands | json_query(query) }}"
    vars:
      query: "[?tags.contains(@, '{{ tag }}')].command"
    when: tag != ""
  
  - name: IF NO TAG PROVIDED - Run all show commands
    set_fact:
      commands: "{{ commands | json_query(query) }}"
    vars:
      query: "[].command"
    when: tag == ""

  - name: Run show commands on remote devices
    cisco.nxos.nxos_command:
      commands: "{{ item }}"
    ignore_errors: yes
    register: echo
    with_items: "{{ commands }}"

  - name:  STDOUT - Verificaiton Commands
    debug: 
      msg: "{{ item.stdout_lines[0] }}"
    with_items: "{{ echo.results }}"
    loop_control:
      label: "{{ item.item }}"